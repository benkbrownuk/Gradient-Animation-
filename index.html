<!DOCTYPE html>
<html>
<head>
  <title>Gradient Boosting Animation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <style>
          body { font-family: Arial, sans-serif; margin: 2em; }
              #plot { width: 600px; height: 400px; }
                </style>
                </head>
                <body>
                  <h1>Gradient Boosting Animation</h1>
                    <div id="plot"></div>
                      <div style="margin-top:1em;">
                          <label>Tree number: <span id="tree-num-label">1</span></label>
                              <input id="tree-slider" type="range" min="1" max="100" value="1" step="1" style="width:300px;">
                                </div>
                                  <div style="margin-top:1em;">
                                      <label>Learning rate:
                                            <select id="lr-select">
                                                    <option value="0.01">0.01</option>
                                                            <option value="0.05">0.05</option>
                                                                    <option value="0.1">0.1</option>
                                                                            <option value="0.2">0.2</option>
                                                                                    <option value="0.3">0.3</option>
                                                                                          </select>
                                                                                              </label>
                                                                                                </div>
                                                                                                  <script>
                                                                                                  // Gradient Boosting Animation with 100 trees and learning rate selection
                                                                                                  
                                                                                                  // Generate synthetic data
                                                                                                  function generateData(n=200) {
                                                                                                      let xs = [], ys = [];
                                                                                                          for (let i=0; i<n; i++) {
                                                                                                                  let x = i/(n-1)*10;
                                                                                                                          let noise = Math.random()*2-1; // noise in [-1,1]
                                                                                                                                  xs.push(x);
                                                                                                                                          ys.push(2 + 0.5*x + Math.sin(x)*2 + noise);
                                                                                                                                              }
                                                                                                                                                  return {xs, ys};
                                                                                                                                                  }
                                                                                                                                                  
                                                                                                                                                  // Simple Decision Stump Regressor for demo purposes
                                                                                                                                                  function fitStump(xs, residuals) {
                                                                                                                                                      // Find best split
                                                                                                                                                          let best_mse = Infinity, best_split = 0, best_left=0, best_right=0;
                                                                                                                                                              for(let s=1; s<xs.length-1; s++) {
                                                                                                                                                                      let split = xs[s];
                                                                                                                                                                              let left = [], right = [];
                                                                                                                                                                                      for(let i=0; i<xs.length; i++) {
                                                                                                                                                                                                  if(xs[i] < split) left.push(residuals[i]);
                                                                                                                                                                                                              else right.push(residuals[i]);
                                                                                                                                                                                                                      }
                                                                                                                                                                                                                              let left_mean = left.reduce((a,b)=>a+b,0)/(left.length||1);
                                                                                                                                                                                                                                      let right_mean = right.reduce((a,b)=>a+b,0)/(right.length||1);
                                                                                                                                                                                                                                              let mse = left.reduce((a,b)=>a+(b-left_mean)**2,0) +
                                                                                                                                                                                                                                                                right.reduce((a,b)=>a+(b-right_mean)**2,0);
                                                                                                                                                                                                                                                                        if(mse < best_mse) {
                                                                                                                                                                                                                                                                                    best_mse = mse;
                                                                                                                                                                                                                                                                                                best_split = split;
                                                                                                                                                                                                                                                                                                            best_left = left_mean;
                                                                                                                                                                                                                                                                                                                        best_right = right_mean;
                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                        return {split: best_split, left: best_left, right: best_right};
                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                        function predictStump(stump, xs) {
                                                                                                                                                                                                                                                                                                                                            return xs.map(x => x < stump.split ? stump.left : stump.right);
                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                            // Gradient boosting fit
                                                                                                                                                                                                                                                                                                                                            function gradientBoostingFit(xs, ys, nTrees=100, lr=0.05) {
                                                                                                                                                                                                                                                                                                                                                let F = Array(xs.length).fill(ys.reduce((a,b)=>a+b,0)/ys.length); // Init with mean
                                                                                                                                                                                                                                                                                                                                                    let models = [];
                                                                                                                                                                                                                                                                                                                                                        for(let t=0; t<nTrees; t++) {
                                                                                                                                                                                                                                                                                                                                                                let residuals = ys.map((y,i)=>y-F[i]);
                                                                                                                                                                                                                                                                                                                                                                        let stump = fitStump(xs, residuals);
                                                                                                                                                                                                                                                                                                                                                                                let pred = predictStump(stump, xs);
                                                                                                                                                                                                                                                                                                                                                                                        F = F.map((f,i)=>f+lr*pred[i]);
                                                                                                                                                                                                                                                                                                                                                                                                models.push({stump: {...stump}, pred: [...F]});
                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                        return models;
                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                        // Drawing with Plotly.js
                                                                                                                                                                                                                                                                                                                                                                                                        function createAnimation() {
                                                                                                                                                                                                                                                                                                                                                                                                            const data = generateData(200);
                                                                                                                                                                                                                                                                                                                                                                                                                let learning_rate = 0.05;
                                                                                                                                                                                                                                                                                                                                                                                                                    let nTrees = 100;
                                                                                                                                                                                                                                                                                                                                                                                                                        let models = gradientBoostingFit(data.xs, data.ys, nTrees, learning_rate);
                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                            let slider = document.getElementById('tree-slider');
                                                                                                                                                                                                                                                                                                                                                                                                                                let lrSelect = document.getElementById('lr-select');
                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                    function redraw(treeNum) {
                                                                                                                                                                                                                                                                                                                                                                                                                                            Plotly.newPlot('plot', [
                                                                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        x: data.xs, y: data.ys,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        mode: 'markers',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: 'Data',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        marker: {color: 'blue', size: 4}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                x: data.xs, y: models[treeNum-1].pred,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                mode: 'lines',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name: 'Model',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                line: {color: 'red', width: 2}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                margin: {t:0},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            showlegend: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('tree-num-label').innerText = treeNum;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        slider.max = nTrees;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            slider.value = 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                slider.addEventListener('input', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        redraw(parseInt(slider.value));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                lrSelect.value = learning_rate;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lrSelect.addEventListener('change', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            learning_rate = parseFloat(lrSelect.value);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    models = gradientBoostingFit(data.xs, data.ys, nTrees, learning_rate);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            redraw(parseInt(slider.value));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    redraw(1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    window.onload = createAnimation;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </body>>